<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Google Workspace ‚Äì MCQ Quiz (Weighted)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#22d3ee; --accent2:#60a5fa; --ok:#10b981; --bad:#ef4444; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 35%,#0b1220);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
  .container{max-width:980px;margin:24px auto;padding:20px}
  .card{background:rgba(17,24,39,.75);backdrop-filter:blur(6px);border:1px solid rgba(148,163,184,.15);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 6px;font-size:clamp(22px,3.6vw,34px)}
  p.lead{margin:.25rem 0 1rem;color:var(--muted)}
  .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  .badge{border:1px solid rgba(148,163,184,.25);padding:4px 10px;border-radius:999px;color:var(--muted);font-size:.85rem}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{appearance:none;border:1px solid transparent;background:var(--accent2);color:#081028;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s ease}
  button.secondary{background:transparent;border-color:rgba(148,163,184,.35);color:var(--text)}
  button:disabled{opacity:.55;cursor:not-allowed}

  .progress{height:10px;background:rgba(148,163,184,.2);border-radius:999px;overflow:hidden;margin:6px 0 12px}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .25s ease}

  .qwrap{border:1px solid rgba(148,163,184,.18);border-radius:14px;padding:16px;min-height:220px}
  .qwrap h3{margin:0 0 8px;font-size:1.02rem}
  .difficulty{font-size:.8rem;color:var(--muted)}

  .options{display:grid;gap:10px;margin-top:12px}
  label.opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid rgba(148,163,184,.2);border-radius:12px;cursor:pointer;transition:.2s ease}
  label.opt:hover{border-color:var(--accent)}
  input[type=radio]{transform:translateY(2px)}
  .hint{color:var(--muted);font-size:.9rem;margin-top:8px}

  .result{margin-top:16px;padding:14px;border-radius:12px;background:rgba(96,165,250,.08);border:1px dashed rgba(96,165,250,.35)}
  .hidden{display:none!important}

  .review{margin-top:18px;display:grid;gap:14px}
  .rev-card{border:1px solid rgba(148,163,184,.2);border-radius:14px;padding:14px;background:rgba(17,24,39,.55)}
  .rev-title{margin:0 0 6px;font-size:1rem}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78rem;border:1px solid rgba(148,163,184,.3);color:var(--muted)}
  .pill.correct{border-color:rgba(16,185,129,.5);color:#c8ffe3}
  .pill.wrong{border-color:rgba(239,68,68,.6);color:#ffd2d2}
  .explain{color:var(--muted);font-size:.95rem;margin-top:6px}

  /* Lifeline modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
  .overlay.hidden{display:none!important}
  .modal{background:var(--panel);border:1px solid rgba(148,163,184,.25);border-radius:16px;padding:18px;max-width:520px;width:92%}
  .modal h4{margin:0 0 8px}
  .modal p{margin:8px 0 14px}
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Google Workspace ‚Äì MCQ Quiz</h1>
      <p class="lead">C√¢u h·ªèi hi·ªÉn th·ªã <strong>l·∫ßn l∆∞·ª£t</strong>. Ch·ªçn ƒë√°p √°n ƒë·ªÉ chuy·ªÉn sang c√¢u ti·∫øp theo. Th·ª© t·ª± c√¢u v√† ƒë√°p √°n <strong>ƒë∆∞·ª£c x√°o tr·ªôn</strong> m·ªói l·∫ßn m·ªü. ƒêi·ªÉm c√≥ tr·ªçng s·ªë theo ph·∫ßn: Ph·∫ßn A (1ƒë), Ph·∫ßn B (2ƒë), Ph·∫ßn C (3ƒë).</p>

      <div class="meta">
        <span class="badge">Ph·∫ßn A: 1ƒë ‚Ä¢ Ph·∫ßn B: 2ƒë ‚Ä¢ Ph·∫ßn C: 3ƒë</span>
        <span class="badge">T·ªïng ƒëi·ªÉm t·ªëi ƒëa: <span id="totalPoints">‚Äî</span></span>
        <div class="row" style="margin-left:auto">
          <button id="lifelineBtn" type="button" title="H·ªèi MVT" aria-haspopup="dialog" aria-controls="overlay">üÜò H·ªèi MVT</button>
          <button id="resetBtn" class="secondary" type="button">Reset</button>
        </div>
      </div>

      <div class="progress" aria-label="progress"><div id="bar" class="bar"></div></div>

      <section id="qContainer" class="qwrap" aria-live="polite"></section>

      <div id="result" class="result hidden" role="status" aria-live="polite"></div>

      <div class="row hidden" id="reviewButtons" style="margin-top:10px">
        <button id="reviewIncorrectBtn" type="button" class="secondary">Xem l·∫°i c√¢u sai</button>
        <button id="reviewAllBtn" type="button" class="secondary">Xem t·∫•t c·∫£</button>
      </div>

      <section id="reviewPanel" class="review hidden" aria-label="Review"></section>

      <p class="lead" style="margin-top:10px">Ngu·ªìn: Slide Google Workspace b·∫°n cung c·∫•p. Gi·∫£i th√≠ch b√°m s√°t n·ªôi dung slide.</p>
    </div>
  </div>

  <!-- Lifeline Modal (H·ªèi MVT) -->
  <div id="overlay" class="overlay hidden" role="dialog" aria-modal="true" aria-labelledby="mvtTitle" aria-hidden="true">
    <div class="modal" role="document">
      <h4 id="mvtTitle">H·ªèi MVT</h4>
      <p><strong>500k TSOSAD255 MBBANK</strong></p>
      <div class="row" style="justify-content:flex-end">
        <button id="okMvt" type="button" autofocus>OK</button>
      </div>
    </div>
  </div>

<script>
'use strict';
// ===============================
// Config (optional telemetry; leave empty to disable)
// ===============================
const TELEMETRY_ENDPOINT = '';
const QUIZ_ID = 'workspace-mcq-v1';
let runId = (self.crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2));

function sendAttempt(summary){
  if(!TELEMETRY_ENDPOINT) return;
  const payload = {
    runId, quizId: QUIZ_ID, timestamp: new Date().toISOString(), pageUrl: location.href,
    userAgent: navigator.userAgent, lifelineUsed,
    earned: summary.earned, total: summary.total, percent: summary.percent, correctCount: summary.correctCount,
    questionOrder: quiz.map(q=>q.id), detail: quiz.map(q=>({id:q.id, picked: (answers[q.id]??null), correctIndex:q.correctIndex, ok: summary.detail[q.id].isCorrect}))
  };
  fetch(TELEMETRY_ENDPOINT, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}).catch(()=>{});
}

// ===============================
// Data (10 c√¢u; tr·ªçng s·ªë theo ph·∫ßn)
// ===============================
const baseQuiz = [
  // Ph·∫ßn A ‚Äì 1ƒë (easy)
  { id:'q1', section:'A', difficulty:'easy', weight:1,
    question:'Google Workspace l√† g√¨?',
    options:['M·ªôt h·ªá ƒëi·ªÅu h√†nh m√°y ch·ªß c·ªßa Google','B·ªô c√¥ng c·ª• vƒÉn ph√≤ng & c·ªông t√°c tr√™n n·ªÅn t·∫£ng ƒë√°m m√¢y','Tr√¨nh duy·ªát web t·ªëi ∆∞u cho Gmail','M·ªôt d·ªãch v·ª• l∆∞u tr·ªØ ·∫£nh tr·ª±c tuy·∫øn'],
    correctIndex:1,
    explainVI:'Google Workspace l√† b·ªô c√¥ng c·ª• ƒë√°m m√¢y ƒë·ªÉ k·∫øt n·ªëi, s√°ng t·∫°o, c·ªông t√°c (Gmail, Drive, Docs/Sheets/Slides,‚Ä¶).',
    explainEN:'A cloud-based productivity & collaboration suite (Gmail, Drive, Docs/Sheets/Slides, etc.).'
  },
  { id:'q2', section:'A', difficulty:'easy', weight:1,
    question:'Th√†nh ph·∫ßn kh√¥ng thu·ªôc nh√≥m ‚ÄúC√¥ng c·ª• giao ti·∫øp‚Äù c·ªßa Workspace l√†:',
    options:['Gmail','Google Meet','Google Chat','Google Sites'],
    correctIndex:3,
    explainVI:'Nh√≥m giao ti·∫øp g·ªìm Gmail, Meet, Chat, Calendar; Sites thu·ªôc nh√≥m t·∫°o trang, kh√¥ng ph·∫£i c√¥ng c·ª• giao ti·∫øp.',
    explainEN:'Comms: Gmail/Meet/Chat/Calendar; Sites is for site building, not a communication tool.'
  },
  { id:'q3', section:'A', difficulty:'easy', weight:1,
    question:'L·ª£i √≠ch kh√¥ng ƒë∆∞·ª£c n√™u khi d√πng Google Drive:',
    options:['Ti·∫øt ki·ªám dung l∆∞·ª£ng thi·∫øt b·ªã','H·ªó tr·ª£ l√†m vi·ªác nh√≥m tr√™n c√πng t·ªáp','Truy c·∫≠p t·ª´ m·ªçi n∆°i, qu·∫£n l√Ω t·∫≠p trung','Ch·ªâ l∆∞u ƒë∆∞·ª£c t·ªáp vƒÉn b·∫£n, kh√¥ng h·ªó tr·ª£ ƒëa ƒë·ªãnh d·∫°ng'],
    correctIndex:3,
    explainVI:'Drive l∆∞u tr·ªØ nhi·ªÅu lo·∫°i t·ªáp, t√≠ch h·ª£p Docs/Sheets/Slides; kh√¥ng b·ªã gi·ªõi h·∫°n ch·ªâ vƒÉn b·∫£n.',
    explainEN:'Drive supports many file types; not limited to text files.'
  },
  { id:'q4', section:'A', difficulty:'easy', weight:1,
    question:'Trong Google Docs, vai tr√≤ cho ph√©p ch·ªâ ƒë·ªçc l√†:',
    options:['Editor','Viewer','Commenter','Owner'],
    correctIndex:1,
    explainVI:'Viewer (xem), Commenter (nh·∫≠n x√©t), Editor (ch·ªânh s·ª≠a); ph√¢n quy·ªÅn qua Share.',
    explainEN:'Viewer is read-only; Commenter can comment; Editor can edit.'
  },
  { id:'q5', section:'A', difficulty:'easy', weight:1,
    question:'Ch·∫ø ƒë·ªô Suggesting (ƒê·ªÅ xu·∫•t) trong Docs d√πng ƒë·ªÉ:',
    options:['·∫®n m·ªçi thay ƒë·ªïi kh·ªèi nh·∫≠t k√Ω phi√™n b·∫£n','G·ª£i √Ω ch·ªânh s·ª≠a ƒë·ªÉ ch·ªß t√†i li·ªáu Accept/Reject','Kh√≥a t√†i li·ªáu kh√¥ng cho ai v√†o','Xu·∫•t tr·ª±c ti·∫øp sang PDF'],
    correctIndex:1,
    explainVI:'Suggesting ghi nh·∫≠n ƒë·ªÅ xu·∫•t; ch·ªß t√†i li·ªáu c√≥ th·ªÉ ch·∫•p nh·∫≠n/t·ª´ ch·ªëi; theo d√µi trong Version history.',
    explainEN:'Proposes edits the owner can accept/reject; tracked in version history.'
  },
  // Ph·∫ßn B ‚Äì 2ƒë (medium)
  { id:'q6', section:'B', difficulty:'medium', weight:2,
    question:'Ph√¢n quy·ªÅn ph√π h·ª£p nh·∫•t cho quy tr√¨nh bi√™n so·∫°n quy ch·∫ø th∆∞ vi·ªán s·ªë l√†:',
    options:['Th·ªß th∆∞ ch√≠nh: Viewer; C·ªông t√°c vi√™n: Editor; GV/SV: Owner','Th·ªß th∆∞ ch√≠nh: Editor; C·ªông t√°c vi√™n: Commenter; GV/SV: Viewer','Th·ªß th∆∞ ch√≠nh: Commenter; C·ªông t√°c vi√™n: Viewer; GV/SV: Editor','T·∫•t c·∫£ ƒë·ªÅu Editor ƒë·ªÉ ‚Äúd·ªÖ l√†m vi·ªác‚Äù'],
    correctIndex:1,
    explainVI:'K·ªãch b·∫£n h·ª£p l√Ω: th·ªß th∆∞ c·∫≠p nh·∫≠t (Editor), CTV g√≥p √Ω (Commenter), GV/SV ƒë·ªçc (Viewer).',
    explainEN:'Librarian as Editor; collaborators Commenter; faculty/students Viewer.'
  },
  { id:'q7', section:'B', difficulty:'medium', weight:2,
    question:'Theo slide, Gemini h·ªó tr·ª£ tr·ª±c ti·∫øp t√°c v·ª• n√†o trong bi√™n m·ª•c/si√™u d·ªØ li·ªáu?',
    options:['Qu√©t m√£ v·∫°ch v√† g√°n ch·ªâ s·ªë Cutter t·ª± ƒë·ªông','ƒê·ªìng b·ªô b·∫£n ghi MARC21 v√†o Koha ch·ªâ b·∫±ng m·ªôt n√∫t','T√≥m t·∫Øt t√†i li·ªáu & tr√≠ch xu·∫•t t√°c gi·∫£, nƒÉm, t·ª´ kh√≥a ƒë·ªÉ t·∫°o si√™u d·ªØ li·ªáu nh·∫•t qu√°n','T·∫°o t√†i kho·∫£n b·∫°n ƒë·ªçc v√† c·∫•p th·∫ª RFID'],
    correctIndex:2,
    explainVI:'Gemini t√≥m t·∫Øt nhanh, tr√≠ch xu·∫•t t√°c gi·∫£, nƒÉm, t·ª´ kh√≥a ‚Üí r√∫t ng·∫Øn th·ªùi gian bi√™n m·ª•c.',
    explainEN:'Summarization and extracting authors/year/keywords to build consistent metadata.'
  },
  { id:'q8', section:'B', difficulty:'medium', weight:2,
    question:'X√¢y d·ª±ng h·ªá th·ªëng H·ªèi‚Äìƒê√°p/FAQ th√¥ng minh theo quy tr√¨nh g·ª£i √Ω trong slide c·∫ßn:',
    options:['Google Forms + Sites, kh√¥ng c·∫ßn d·ªØ li·ªáu','Google Sheets (d·ªØ li·ªáu) + Gemini (t·∫°o n·ªôi dung) + AppSheet (giao di·ªán/chatbot)','Google Photos + Meet','Ch·ªâ c·∫ßn Gmail v√† Calendar'],
    correctIndex:1,
    explainVI:'T·∫°o d·ªØ li·ªáu Q&A trong Sheets, d√πng Gemini sinh n·ªôi dung/bi·∫øn th·ªÉ, d·ª±ng AppSheet ƒë·ªÉ truy v·∫•n & tr·∫£ l·ªùi.',
    explainEN:'Sheets as data, Gemini to generate, AppSheet as UI/chatbot.'
  },
  // Ph·∫ßn C ‚Äì 3ƒë (hard)
  { id:'q9', section:'C', difficulty:'hard', weight:3,
    question:'T√¨m ki·∫øm n√†o cho k·∫øt qu·∫£ li√™n quan nh·∫•t v·ªõi truy v·∫•n d√†i trong Drive theo slide?',
    options:['T√¨m t·ª´ng t·ª´ kh√≥a r·ªùi r·∫°c','L·ªçc theo dung l∆∞·ª£ng file l·ªõn nh·∫•t','D√πng AI Semantic Search c·ªßa Gemini tr√™n Drive ƒë·ªÉ hi·ªÉu √Ω ƒë·ªãnh & kh√°i ni·ªám li√™n quan','Ch·ªâ t√¨m trong ti√™u ƒë·ªÅ file, b·ªè qua n·ªôi dung'],
    correctIndex:2,
    explainVI:'T√¨m ki·∫øm ng·ªØ nghƒ©a theo √Ω ƒë·ªãnh, nh·∫≠n bi·∫øt ƒë·ªìng nghƒ©a/ng·ªØ c·∫£nh, v∆∞·ª£t tr·ªôi so v·ªõi keyword match.',
    explainEN:'Use AI semantic search (Gemini) for intent, synonyms, and context.'
  },
  { id:'q10', section:'C', difficulty:'hard', weight:3,
    question:'Theo quy tr√¨nh trong slide v·ªÅ ph√¢n t√≠ch & tr·ª±c quan h√≥a d·ªØ li·ªáu th∆∞ vi·ªán b·∫±ng Gemini trong Sheets, y√™u c·∫ßu n√†o ph√π h·ª£p ƒë·ªÉ nh·∫≠n k·∫øt qu·∫£ ph√¢n t√≠ch k√®m bi·ªÉu ƒë·ªì?',
    options:['Cho xem t·∫•t c·∫£ d·ªØ li·ªáu th√¥, kh√¥ng c·∫ßn t·ªïng h·ª£p','Ph√¢n t√≠ch d·ªØ li·ªáu n√†y v√† cho bi·∫øt 5 th·ªÉ lo·∫°i m∆∞·ª£n nhi·ªÅu nh·∫•t qu√Ω 3; t·∫°o m·ªôt bi·ªÉu ƒë·ªì tr√≤n minh h·ªça.','V·∫Ω m·ªçi bi·ªÉu ƒë·ªì c√≥ th·ªÉ (kh√¥ng n√™u m·ª•c ti√™u)','G·ª≠i email k·∫øt qu·∫£ cho to√†n b·ªô sinh vi√™n'],
    correctIndex:1,
    explainVI:'V√≠ d·ª• l·ªánh: top 5 th·ªÉ lo·∫°i & v·∫Ω bi·ªÉu ƒë·ªì (c≈©ng c√≥ v√≠ d·ª• xu h∆∞·ªõng theo gi·ªù + bi·ªÉu ƒë·ªì ƒë∆∞·ªùng).',
    explainEN:'Ask for top categories and request a chart (e.g., pie chart).'
  }
];

// Shuffle options per question
const SHUFFLE_OPTIONS = true;

// ===============================
// Utilities
// ===============================
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

// ===============================
// State
// ===============================
let quiz = [];
let current = 0;
const answers = {}; // id -> pickedIndex (in displayed order)
let lifelineUsed = false;

// UI refs
const totalPointsEl = document.getElementById('totalPoints');
const qContainer = document.getElementById('qContainer');
const bar = document.getElementById('bar');
const resultEl = document.getElementById('result');
const reviewBtns = document.getElementById('reviewButtons');
const reviewIncorrectBtn = document.getElementById('reviewIncorrectBtn');
const reviewAllBtn = document.getElementById('reviewAllBtn');
const reviewPanel = document.getElementById('reviewPanel');
const resetBtn = document.getElementById('resetBtn');
const lifelineBtn = document.getElementById('lifelineBtn');
const overlay = document.getElementById('overlay');
const okMvt = document.getElementById('okMvt');

function totalPossiblePoints(){ return quiz.reduce((s,q)=>s+q.weight,0); }
function renderProgress(){ bar.style.width = Math.round((current/quiz.length)*100) + '%'; }

function renderQuestion(){
  renderProgress(); reviewPanel.classList.add('hidden'); reviewBtns.classList.add('hidden'); resultEl.classList.add('hidden');
  const q = quiz[current]; const qNumber = current + 1; qContainer.innerHTML = '';

  const title = document.createElement('h3');
  title.innerHTML = `<span style="opacity:.9">Q${qNumber}/${quiz.length}</span> ‚Äî ${q.question}`;
  const diff = document.createElement('div'); diff.className = 'difficulty';
  diff.textContent = `Ph·∫ßn ${q.section} ‚Ä¢ Difficulty: ${q.difficulty} ‚Ä¢ Weight: ${q.weight}`;

  const opts = document.createElement('div'); opts.className = 'options';
  q.choices.forEach((choice, oi)=>{
    const id = `${q.id}_${oi}`;
    const label = document.createElement('label'); label.className = 'opt'; label.setAttribute('for', id);
    const radio = document.createElement('input'); radio.type = 'radio'; radio.name = q.id; radio.id = id; radio.value = String(oi);
    const text = document.createElement('div'); const letter = String.fromCharCode(65+oi);
    text.innerHTML = `<strong>${letter}.</strong> ${choice.text}`;

    radio.addEventListener('change', ()=>{
      answers[q.id] = oi; // store picked displayed index
      label.style.borderColor = 'var(--accent)';
      setTimeout(()=>{ nextStep(); }, 200);
    });

    label.appendChild(radio); label.appendChild(text); opts.appendChild(label);
  });

  qContainer.appendChild(title); qContainer.appendChild(diff); qContainer.appendChild(opts);
  const hint = document.createElement('div'); hint.className = 'hint'; hint.textContent = 'Ch·ªçn ƒë√°p √°n ƒë·ªÉ ti·∫øp t·ª•c‚Ä¶';
  qContainer.appendChild(hint);
}

function scoreQuiz(){
  let earned = 0, correctCount = 0; const detail = {};
  quiz.forEach(q=>{
    const pick = answers[q.id];
    const isCorrect = (pick !== undefined) && q.choices[pick] && q.choices[pick].isCorrect === true;
    if(isCorrect){ earned += q.weight; correctCount++; }
    detail[q.id] = { isCorrect, picked: pick ?? null, correctIndex: q.choices.findIndex(c=>c.isCorrect) };
  });
  const total = totalPossiblePoints(); const percent = Math.round(100*earned/total);
  return { earned, total, percent, correctCount, detail };
}

function finish(){
  bar.style.width = '100%';
  const summary = scoreQuiz();
  // optional telemetry
  sendAttempt(summary);

  resultEl.classList.remove('hidden');
  resultEl.innerHTML = `<div><strong>T·ª© ƒë·∫°i linh th√∫ TEAM ƒë√£ ch·∫•m cho b·∫°n:</strong> ${summary.earned} ƒëi·ªÉm</div>
    <div style="color:var(--muted)">Chi ti·∫øt: ${summary.earned} / ${summary.total} ƒëi·ªÉm (${summary.percent}%). ƒê√∫ng: ${summary.correctCount}/${quiz.length}.</div>`;
  reviewBtns.classList.remove('hidden');
}

function buildReviewCards(filterFn){
  reviewPanel.innerHTML = '';
  const summary = scoreQuiz();
  quiz.forEach((q, qi)=>{
    const row = summary.detail[q.id]; if(!filterFn(row)) return;
    const card = document.createElement('div'); card.className = 'rev-card';

    const title = document.createElement('h4'); title.className = 'rev-title'; title.textContent = `Q${qi+1} ‚Äî Ph·∫ßn ${q.section}`;
    const status = document.createElement('div'); status.innerHTML = row.isCorrect ? '<span class="pill correct">Correct</span>' : '<span class="pill wrong">Incorrect</span>';

    const userPickIdx = row.picked;
    const userPickTxt = (userPickIdx!==null && userPickIdx!==undefined) ? `${String.fromCharCode(65+userPickIdx)}. ${q.choices[userPickIdx].text}` : '‚Äî (ch∆∞a ch·ªçn)';
    const correctIdx = row.correctIndex;
    const correctTxt = `${String.fromCharCode(65+correctIdx)}. ${q.choices[correctIdx].text}`;

    const picked = document.createElement('div'); picked.innerHTML = `<strong>ƒê√°p √°n b·∫°n ch·ªçn:</strong> ${userPickTxt}`;
    const correct = document.createElement('div'); correct.innerHTML = `<strong>ƒê√°p √°n ƒë√∫ng:</strong> ${correctTxt}`;

    const explain = document.createElement('div'); explain.className = 'explain'; explain.innerHTML = `<em>Gi·∫£i th√≠ch:</em> ${q.explainVI}<br/><em>Why (EN):</em> ${q.explainEN}`;

    const foot = document.createElement('div'); foot.className = 'difficulty'; foot.textContent = `Difficulty: ${q.difficulty} ‚Ä¢ Weight: ${q.weight}`;

    card.appendChild(title); card.appendChild(status); card.appendChild(picked); card.appendChild(correct); card.appendChild(explain); card.appendChild(foot);
    reviewPanel.appendChild(card);
  });
  reviewPanel.classList.remove('hidden');
}

function nextStep(){
  current++;
  if(current < quiz.length){ renderQuestion(); }
  else { qContainer.innerHTML = '<em>ƒê√£ tr·∫£ l·ªùi t·∫•t c·∫£ c√¢u h·ªèi.</em>'; finish(); }
}

function start(){
  // clone and shuffle order of questions
  quiz = shuffle(baseQuiz.slice());
  // shuffle options per question while preserving truth
  quiz.forEach(q=>{
    const arr = q.options.map((text, idx)=>({ text, isCorrect: idx===q.correctIndex }));
    q.choices = SHUFFLE_OPTIONS ? shuffle(arr) : arr;
  });
  Object.keys(answers).forEach(k=>delete answers[k]);
  current = 0; lifelineUsed = false; lifelineBtn.disabled = false;
  totalPointsEl.textContent = totalPossiblePoints();
  bar.style.width = '0%';
  closeMVT();
  renderQuestion();
}

// Lifeline modal logic (one-time, user-initiated only)
function openMVT(){ overlay.classList.remove('hidden'); overlay.removeAttribute('aria-hidden'); setTimeout(()=>okMvt.focus(),0); }
function closeMVT(){ overlay.classList.add('hidden'); overlay.setAttribute('aria-hidden','true'); }

// Bindings
const reviewIncorrectBtn = document.getElementById('reviewIncorrectBtn');
const reviewAllBtn = document.getElementById('reviewAllBtn');
reviewIncorrectBtn.addEventListener('click', ()=> buildReviewCards(row=>!row.isCorrect));
reviewAllBtn.addEventListener('click', ()=> buildReviewCards(()=>true));

const resetBtn = document.getElementById('resetBtn');
resetBtn.addEventListener('click', ()=>{ reviewPanel.classList.add('hidden'); reviewBtns.classList.add('hidden'); resultEl.classList.add('hidden'); start(); });

const lifelineBtn = document.getElementById('lifelineBtn');
lifelineBtn.addEventListener('click', (e)=>{ e.preventDefault(); if(lifelineUsed) return; openMVT(); });
const okMvt = document.getElementById('okMvt');
okMvt.addEventListener('click', ()=>{ closeMVT(); lifelineUsed = true; lifelineBtn.disabled = true; });
window.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape' && !overlay.classList.contains('hidden')) closeMVT(); });

// ===============================
// Self-tests (console) ‚Äì to ensure scoring/weights are correct
// ===============================
(function runSelfTests(){
  const tests = [];
  // 1) Weight sum = 17 (A:5√ó1 + B:3√ó2 + C:2√ó3)
  tests.push((()=> baseQuiz.reduce((s,q)=>s+q.weight,0)===17)());
  // 2) Correct indices map to right text
  tests.push((()=> baseQuiz.every(q=> q.options[q.correctIndex] !== undefined))());
  // 3) Scoring with all-correct gives full points
  (function(){
    const clone = baseQuiz.map(q=>({ ...q }));
    clone.forEach(q=>{ q.choices = q.options.map((t,i)=>({text:t,isCorrect:i===q.correctIndex})); });
    const tmpQuiz = clone;
    const tmpAns = {}; tmpQuiz.forEach(q=>{ tmpAns[q.id] = q.choices.findIndex(c=>c.isCorrect); });
    const earned = tmpQuiz.reduce((s,q)=> s + (q.choices[tmpAns[q.id]].isCorrect ? q.weight:0), 0);
    tests.push(earned === 17);
  })();
  console.log('[Workspace MCQ] Self-tests pass=', tests.every(Boolean), tests);
})();

// Init
start();
</script>
</body>
</html>
